name: Build Hytale Server Image

on:
  push:
    branches:
      - master
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force a rebuild even if upstream version is unchanged"
        type: boolean
        default: false

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      build: ${{ steps.should_build.outputs.build }}
      version: ${{ steps.upstream.outputs.version }}
      version_tag: ${{ steps.tags.outputs.version_tag }}
      timestamp_tag: ${{ steps.tags.outputs.timestamp_tag }}
    env:
      HOME: /home/runner
      XDG_CONFIG_HOME: /home/runner/.config
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Hytale downloader tool
        shell: bash
        run: |
          curl -fsSL "https://downloader.hytale.com/hytale-downloader.zip" -o hytale-downloader.zip
          unzip -q hytale-downloader.zip
          chmod +x hytale-downloader-linux-amd64

      - name: Setup OAuth credentials
        shell: bash
        run: |
          echo "Using HOME=${HOME}"
          if [ -n "${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS_B64 }}" ]; then
            echo "${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS_B64 }}" | base64 -d > ~/.hytale-downloader-credentials.json
            echo "Using base64 credential secret"
          else
            echo "::error::No downloader credentials provided"
            exit 1
          fi

          chmod 600 ~/.hytale-downloader-credentials.json
          mkdir -p ~/.config/hytale-downloader ~/.hytale-downloader
          cp ~/.hytale-downloader-credentials.json ~/.config/hytale-downloader/credentials.json
          cp ~/.hytale-downloader-credentials.json ~/.hytale-downloader/credentials.json
          cp ~/.hytale-downloader-credentials.json "${GITHUB_WORKSPACE}/.hytale-downloader-credentials.json"
          mkdir -p "${GITHUB_WORKSPACE}/.config/hytale-downloader"
          cp ~/.hytale-downloader-credentials.json "${GITHUB_WORKSPACE}/.config/hytale-downloader/credentials.json"

          python3 -c "import json; p='/home/runner/.hytale-downloader-credentials.json'; d=json.load(open(p)); t=d.get('refresh_token',''); print(f'Refresh token length: {len(t)}')"

      - name: Get upstream version
        id: upstream
        shell: bash
        run: |
          echo "Running downloader to get version..."
          ./hytale-downloader-linux-amd64 -print-version
          version=$(./hytale-downloader-linux-amd64 -print-version 2>&1 | tail -n 1 | tr -d '\r\n ')
          echo "Captured version: ${version}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Get current release version
        id: current
        shell: bash
        run: |
          version=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // ""' | sed 's/^v//')
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "Current version: ${version:-none}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine if build is needed
        id: should_build
        shell: bash
        run: |
          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            echo "build=true" >> "$GITHUB_OUTPUT"
            echo "Build forced via workflow_dispatch"
          elif [ "${{ steps.current.outputs.version }}" = "${{ steps.upstream.outputs.version }}" ]; then
            echo "build=false" >> "$GITHUB_OUTPUT"
            echo "Version unchanged (${{ steps.upstream.outputs.version }}), skipping build"
          else
            echo "build=true" >> "$GITHUB_OUTPUT"
            echo "Version changed: ${{ steps.current.outputs.version || 'none' }} -> ${{ steps.upstream.outputs.version }}"
          fi

      - name: Generate tags
        id: tags
        shell: bash
        run: |
          version="${{ steps.upstream.outputs.version }}"
          timestamp=$(date -u +%Y%m%d-%H%M%S)
          echo "version_tag=v${version}" >> "$GITHUB_OUTPUT"
          echo "timestamp_tag=build-${timestamp}" >> "$GITHUB_OUTPUT"

  build-image:
    runs-on: ubuntu-latest
    needs: plan
    if: needs.plan.outputs.build == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            suffix: amd64
          - platform: linux/arm64
            suffix: arm64
    env:
      HOME: /home/runner
      XDG_CONFIG_HOME: /home/runner/.config
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Hytale downloader tool
        shell: bash
        run: |
          curl -fsSL "https://downloader.hytale.com/hytale-downloader.zip" -o hytale-downloader.zip
          unzip -q hytale-downloader.zip
          chmod +x hytale-downloader-linux-amd64

      - name: Setup OAuth credentials
        shell: bash
        run: |
          echo "Using HOME=${HOME}"
          if [ -n "${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS_B64 }}" ]; then
            echo "${{ secrets.HYTALE_DOWNLOADER_CREDENTIALS_B64 }}" | base64 -d > ~/.hytale-downloader-credentials.json
            echo "Using base64 credential secret"
          else
            echo "::error::No downloader credentials provided"
            exit 1
          fi

          chmod 600 ~/.hytale-downloader-credentials.json
          mkdir -p ~/.config/hytale-downloader ~/.hytale-downloader
          cp ~/.hytale-downloader-credentials.json ~/.config/hytale-downloader/credentials.json
          cp ~/.hytale-downloader-credentials.json ~/.hytale-downloader/credentials.json
          cp ~/.hytale-downloader-credentials.json "${GITHUB_WORKSPACE}/.hytale-downloader-credentials.json"
          mkdir -p "${GITHUB_WORKSPACE}/.config/hytale-downloader"
          cp ~/.hytale-downloader-credentials.json "${GITHUB_WORKSPACE}/.config/hytale-downloader/credentials.json"

      - name: Download server files
        shell: bash
        run: |
          echo "Using HOME=${HOME}"
          export XDG_CONFIG_HOME="${XDG_CONFIG_HOME:-$HOME/.config}"
          mkdir -p output
          cd output
          cp "${GITHUB_WORKSPACE}/.hytale-downloader-credentials.json" ./ || true
          mkdir -p .config/hytale-downloader
          cp "${GITHUB_WORKSPACE}/.config/hytale-downloader/credentials.json" .config/hytale-downloader/credentials.json || true
          ../hytale-downloader-linux-amd64
          cd ..

      - name: Extract and prepare server files
        shell: bash
        run: |
          mkdir -p stage package
          latest_zip=$(ls -t output/*.zip | head -n 1)
          unzip -q "$latest_zip" -d stage
          cp "$(find stage -name 'Assets.zip' -type f)" package/Assets.zip
          cp "$(find stage -name 'HytaleServer.jar' -type f)" package/HytaleServer.jar
          cp "$(find stage -name 'HytaleServer.aot' -type f)" package/HytaleServer.aot
          cp server/Dockerfile package/Dockerfile

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: package
          file: package/Dockerfile
          push: true
          platforms: ${{ matrix.platform }}
          tags: |
            ghcr.io/${{ github.repository_owner }}/hytale-server:latest-${{ matrix.suffix }}
            ghcr.io/${{ github.repository_owner }}/hytale-server:${{ needs.plan.outputs.version_tag }}-${{ matrix.suffix }}
            ghcr.io/${{ github.repository_owner }}/hytale-server:${{ needs.plan.outputs.timestamp_tag }}-${{ matrix.suffix }}

  publish:
    runs-on: ubuntu-latest
    needs: [plan, build-image]
    if: needs.plan.outputs.build == 'true'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish multi-arch manifests
        shell: bash
        run: |
          image="ghcr.io/${{ github.repository_owner }}/hytale-server"
          version_tag="${{ needs.plan.outputs.version_tag }}"
          timestamp_tag="${{ needs.plan.outputs.timestamp_tag }}"

          docker buildx imagetools create -t "${image}:latest" \
            "${image}:latest-amd64" \
            "${image}:latest-arm64"

          docker buildx imagetools create -t "${image}:${version_tag}" \
            "${image}:${version_tag}-amd64" \
            "${image}:${version_tag}-arm64"

          docker buildx imagetools create -t "${image}:${timestamp_tag}" \
            "${image}:${timestamp_tag}-amd64" \
            "${image}:${timestamp_tag}-arm64"

      - name: Create release
        shell: bash
        run: |
          notes_file="$(mktemp)"
          printf '%s\n' \
            "**Version:** ${{ needs.plan.outputs.version }}" \
            "**Built:** ${{ needs.plan.outputs.timestamp_tag }}" \
            "" \
            "### Docker Image" \
            "```" \
            "docker pull ghcr.io/${{ github.repository_owner }}/hytale-server:${{ needs.plan.outputs.version_tag }}" \
            "```" \
            "" \
            "### Tags" \
            "- \`latest\`" \
            "- \`${{ needs.plan.outputs.version_tag }}\`" \
            "- \`${{ needs.plan.outputs.timestamp_tag }}\`" \
            > "${notes_file}"

          gh release create "${{ needs.plan.outputs.version_tag }}" \
            --title "Hytale Server ${{ needs.plan.outputs.version }}" \
            --notes-file "${notes_file}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
